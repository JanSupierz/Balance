@model IEnumerable<Balance.Areas.Admin.ViewModels.UserWithRolesViewModel>
@using Balance.Models
@using Balance.ViewModels

@{
    ViewData["Title"] = "Admin Dashboard";
    var pagination = ViewBag.Pagination as PaginationInfo;
    var allowedRoles = Enum.GetValues(typeof(Role)).Cast<Role>().ToList();
}

<div class="row g-4 mb-5">
    <div class="col-md-4">
        <div class="card h-100 p-3 shadow-sm border">
            <div class="d-flex align-items-center">
                <div class="icon-circle md theme-primary me-3">
                    <i class="bi bi-people-fill"></i>
                </div>
                <div>
                    <h6 class="text-muted small mb-0 text-uppercase fw-bold">Total Users</h6>
                    <h3 class="mb-0 fw-bold">@pagination.TotalItems</h3>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card h-100 p-3 shadow-sm border">
            <div class="d-flex align-items-center">
                <div class="icon-circle md theme-success me-3">
                    <i class="bi bi-shield-lock-fill"></i>
                </div>
                <div>
                    <h6 class="text-muted small mb-0 text-uppercase fw-bold">Admins</h6>
                    <h3 class="mb-0 fw-bold">@Model.Count(u => u.Roles.Contains(Role.Admin))</h3>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger border-0 shadow-sm h-100 d-flex align-items-center mb-0" role="alert">
                <i class="bi bi-exclamation-octagon-fill me-2 fs-5"></i>
                <div>@TempData["ErrorMessage"]</div>
            </div>
        }
        else if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success border-0 shadow-sm h-100 d-flex align-items-center mb-0" role="alert">
                <i class="bi bi-check-circle-fill me-2 fs-5"></i>
                <div>@TempData["SuccessMessage"]</div>
            </div>
        }
    </div>
</div>

<div class="card card-clean shadow-sm border">

    <div class="card-header border-0 p-4 pb-0 bg-transparent">
        <div class="row g-3 align-items-center justify-content-between">
            <div class="col-md-4">
                <h4 class="fw-bold mb-0">User Management</h4>
            </div>
            <div class="col-md-8">
                <form method="get" class="d-flex gap-2 justify-content-md-end">
                    <div class="position-relative" style="min-width: 250px;">
                        <i class="bi bi-search" style="position:absolute; left: 1.2rem; top: 50%; transform: translateY(-50%); color: var(--text-muted); z-index: 5;"></i>
                        <input type="text" name="searchTerm" value="@pagination.SearchTerm"
                               class="form-control rounded-pill ps-5"
                               placeholder="Search users...">
                    </div>
                    <select name="pageSize" class="form-select w-auto rounded-pill" onchange="this.form.submit()">
                        @foreach (var size in pagination.PageSizes)
                        {
                            <option value="@size" selected="@(size == pagination.PageSize ? "selected" : null)">@size rows</option>
                        }
                    </select>
                </form>
            </div>
        </div>
    </div>

    <div class="card-body p-0 mt-3">
        <div class="table-responsive">
            <table class="table align-middle mb-0">
                <thead>
                    <tr>
                        <th class="ps-4 py-3 text-uppercase small fw-bold">User Identity</th>
                        <th class="py-3 text-uppercase small fw-bold">Roles</th>
                        <th class="text-end pe-4 py-3 text-uppercase small fw-bold">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        var isCurrentUser = item.User.UserName == User.Identity.Name;
                        var firstLetter = item.User.UserName?.FirstOrDefault().ToString().ToUpper() ?? "U";
                        var availableRoles = allowedRoles.Except(item.Roles).ToList();

                        <tr style="border-color: var(--border-color);">
                            <td class="ps-4">
                                <div class="d-flex align-items-center">
                                    <div class="icon-circle avatar-gradient me-3">@firstLetter</div>
                                    <div>
                                        <div class="fw-bold">@item.User.UserName</div>
                                        <div class="text-muted small">@item.User.Email</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex flex-wrap align-items-center gap-2">
                                    @foreach (var role in item.Roles)
                                    {
                                        // FIXED: Use 'theme-secondary' instead of 'theme-dark' for Users
                                        var badgeClass = role == Role.Admin ? "theme-primary" : "theme-secondary";
                                        var icon = role == Role.Admin ? "bi-shield-fill" : "bi-person-fill";
                                        var canRemove = !(isCurrentUser && role == Role.Admin);

                                        <div class="badge rounded-pill border fw-normal d-inline-flex align-items-center px-3 py-2 @badgeClass" style="border-color: transparent;">
                                            <i class="bi @icon me-1"></i> @role
                                            @if (canRemove)
                                            {
                                                <form method="post" asp-action="ChangeRole" class="d-inline-flex ms-2">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="userId" value="@item.User.Id" />
                                                    <input type="hidden" name="role" value="@role" />
                                                    <input type="hidden" name="addRole" value="false" />
                                                    <button type="submit" class="btn p-0 border-0 text-inherit opacity-50" title="Remove role" style="color:inherit;">
                                                        <i class="bi bi-x-circle-fill"></i>
                                                    </button>
                                                </form>
                                            }
                                        </div>
                                    }

                                    @if (availableRoles.Any())
                                    {
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-light rounded-circle border" style="width: 28px; height: 28px; padding: 0;" data-bs-toggle="dropdown">
                                                <i class="bi bi-plus-lg"></i>
                                            </button>
                                            <ul class="dropdown-menu border-0 shadow-sm rounded-3">
                                                <li><h6 class="dropdown-header text-uppercase small">Assign Role</h6></li>
                                                @foreach (var role in availableRoles)
                                                {
                                                    <li>
                                                        <form method="post" asp-action="ChangeRole">
                                                            @Html.AntiForgeryToken()
                                                            <input type="hidden" name="userId" value="@item.User.Id" />
                                                            <input type="hidden" name="role" value="@role" />
                                                            <input type="hidden" name="addRole" value="true" />
                                                            <button type="submit" class="dropdown-item">
                                                                <i class="bi bi-plus-circle me-2 text-primary"></i>@role
                                                            </button>
                                                        </form>
                                                    </li>
                                                }
                                            </ul>
                                        </div>
                                    }
                                </div>
                            </td>
                            <td class="text-end pe-4">
                                @if (!isCurrentUser)
                                {
                                    <button type="button" class="btn btn-sm btn-soft-danger js-delete-trigger rounded-pill px-3"
                                            data-id="@item.User.Id"
                                            data-title="@item.User.UserName">
                                        <i class="bi bi-trash me-1"></i> Delete
                                    </button>
                                }
                                else
                                {
                                    <span class="badge bg-light text-muted border">You</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (pagination.TotalPages > 1)
        {
            <div class="d-flex justify-content-between align-items-center p-4 border-top" style="border-color: var(--border-color) !important;">
                <span class="text-muted small">Showing @(((pagination.CurrentPage - 1) * pagination.PageSize) + 1) to @Math.Min(pagination.CurrentPage * pagination.PageSize, pagination.TotalItems) of @pagination.TotalItems users</span>
                <nav>
                    <ul class="pagination mb-0 gap-1">
                        <li class="page-item @(pagination.HasPrevious ? "" : "disabled")">
                            <a class="page-link rounded-circle btn-light border" href="?searchTerm=@pagination.SearchTerm&pageSize=@pagination.PageSize&page=@(pagination.CurrentPage - 1)">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                        <li class="page-item disabled"><span class="page-link border-0 bg-transparent text-muted">Page @pagination.CurrentPage</span></li>
                        <li class="page-item @(pagination.HasNext ? "" : "disabled")">
                            <a class="page-link rounded-circle btn-light border" href="?searchTerm=@pagination.SearchTerm&pageSize=@pagination.PageSize&page=@(pagination.CurrentPage + 1)">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        }
    </div>
</div>

<div class="modal fade" id="deleteUserModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-0"><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body text-center pt-0 pb-4">
                <div class="mb-3">
                    <div class="icon-circle lg theme-danger mx-auto"><i class="bi bi-exclamation-triangle-fill"></i></div>
                </div>
                <h4 class="fw-bold">Delete User?</h4>
                <p class="text-muted">Are you sure you want to delete <span class="fw-bold text-dark js-delete-title"></span>?</p>
                <form method="post" asp-action="DeleteUser">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="userId" class="js-delete-id" />
                    <div class="d-flex justify-content-center gap-2 mt-4">
                        <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger px-4">Yes, Delete</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.body.addEventListener('click', function(e) {
                const btn = e.target.closest('.js-delete-trigger');
                if(btn) {
                    e.preventDefault();
                    const modalEl = document.getElementById('deleteUserModal');
                    if(modalEl) {
                        const idInput = modalEl.querySelector('.js-delete-id');
                        const titleSpan = modalEl.querySelector('.js-delete-title');

                        if(idInput) idInput.value = btn.dataset.id;
                        if(titleSpan) titleSpan.textContent = btn.dataset.title;

                        const modalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
                        modalInstance.show();
                    }
                }
            });
        });
    </script>
}