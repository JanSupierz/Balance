@model Balance.Models.UserTask
@using Balance.Models
@using Balance.Models.Enums

@{
    ViewData["Title"] = "Create Task";
    var existingTags = ViewBag.UserTags as List<Balance.Models.TaskTag> ?? new List<Balance.Models.TaskTag>();
}

@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
<input type="hidden" id="antiforgeryToken" value="@Antiforgery.GetAndStoreTokens(Context).RequestToken" />

<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card card-clean shadow-sm border">
            <div class="card-body p-4">
                <h3 class="mb-4 fw-bold" style="color: var(--primary-base);"><i class="bi bi-plus-circle me-2"></i>New Task</h3>

                <form asp-action="Create">
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <div class="mb-3">
                        <label asp-for="Title" class="form-label fw-bold">Title</label>
                        <input asp-for="Title" class="form-control form-control-lg" placeholder="e.g. Drink Water" />
                        <span asp-validation-for="Title" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Description" class="form-label">Description</label>
                        <textarea asp-for="Description" class="form-control" rows="2"></textarea>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">Tags</label>
                        <div class="input-group mb-2">
                            <input type="color" id="newTagColor" class="form-control form-control-color" value="#4f46e5" title="Color" style="max-width: 45px;">
                            <input type="text" id="newTagName" class="form-control" placeholder="New tag name..." />
                            <button type="button" class="btn btn-primary" id="btnCreateTag">Add</button>
                        </div>
                        <div class="card border">
                            <div class="card-body p-3" id="tagsContainer" style="background-color: var(--bg-app);">
                                <div id="noTagsMsg" class="text-muted small text-center @(existingTags.Any() ? "d-none" : "")">
                                    No tags yet.
                                </div>
                                <div class="d-flex flex-wrap gap-2" id="tagsList">
                                    @foreach (var tag in existingTags)
                                    {
                                        <div class="tag-wrapper" id="tag-wrapper-@tag.Id">
                                            <input class="form-check-input d-none tag-checkbox" type="checkbox" name="selectedTagIds" value="@tag.Id" id="tag_@tag.Id" data-color="@tag.Color">
                                            <label class="badge rounded-pill fw-normal tag-label badge-tag d-flex align-items-center gap-2" for="tag_@tag.Id">
                                                @tag.Name
                                            </label>
                                            <button type="button" class="btn-delete-tag" onclick="deleteTag(@tag.Id)"><i class="bi bi-x"></i></button>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label asp-for="Frequency" class="form-label fw-bold">Frequency</label>
                            <select asp-for="Frequency" class="form-select" id="frequencySelect" asp-items="Html.GetEnumSelectList<Frequency>()"></select>
                        </div>
                        <div class="col-md-6">
                            <label asp-for="HowManyTimes" class="form-label fw-bold">Repetitions</label>
                            <input asp-for="HowManyTimes" type="number" min="1" class="form-control" value="1" />
                        </div>
                    </div>

                    <div class="mb-4 d-none" id="deadlineInputContainer">
                        <label class="form-label fw-bold">Due Date</label>
                        <div class="input-group">
                            <span class="input-group-text" style="background-color: var(--bg-surface); border-color: var(--border-color);">
                                <i class="bi bi-calendar-event" style="color: var(--text-main);"></i>
                            </span>
                            <input type="date" id="deadlineDate" name="customDeadline" class="form-control" />
                        </div>
                    </div>

                    <div class="mb-4">
                        <label asp-for="PointsPerClick" class="form-label fw-bold">Points per Click</label>
                        <div class="input-group">
                            <span class="input-group-text border-end-0" style="background-color: var(--bg-surface); border-color: var(--border-color);">
                                <i class="bi bi-star-fill text-warning"></i>
                            </span>
                            <input asp-for="PointsPerClick" type="number" min="0" class="form-control border-start-0" value="10" />
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a asp-action="Index" class="btn btn-light border me-md-2">Cancel</a>
                        <button type="submit" class="btn btn-primary px-4 btn-pill-action">Create Task</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        const token = document.getElementById('antiforgeryToken').value;
        const select = document.getElementById('frequencySelect');
        const container = document.getElementById('deadlineInputContainer');

        function toggleDate() {
            const selectedText = select.options[select.selectedIndex].text;
            if (selectedText === "OneTime") container.classList.remove('d-none');
            else container.classList.add('d-none');
        }
        select.addEventListener('change', toggleDate);
        toggleDate();

        function updateTagVisuals(checkbox) {
            const label = document.querySelector(`label[for="${checkbox.id}"]`);
            if (!label) return;

            const color = checkbox.dataset.color || '#4f46e5';

            if (checkbox.checked) {
                label.style.backgroundColor = color;
                label.style.color = '#ffffff';
                label.style.borderColor = color;
            } else {
                label.style.backgroundColor = 'var(--bg-surface)';
                label.style.color = 'var(--text-main)';
                label.style.borderColor = 'var(--border-color)';
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.tag-checkbox').forEach(cb => {
                updateTagVisuals(cb);
                cb.addEventListener('change', () => updateTagVisuals(cb));
            });

            // Date picker behavior
            const dateInput = document.getElementById('deadlineDate');

            // Prevent highlighting the text
            dateInput.style.userSelect = 'none';
            dateInput.addEventListener('mousedown', e => e.preventDefault());

            // Only clicking the input opens the calendar
            dateInput.addEventListener('click', function () {
                if (typeof dateInput.showPicker === 'function') {
                    dateInput.showPicker();
                }
            });

            // Disable clicks on the icon
            const iconSpan = document.querySelector('#deadlineInputContainer .input-group-text');
            iconSpan.style.pointerEvents = 'none';
        });

        document.getElementById('btnCreateTag').addEventListener('click', async function () {
            const inputName = document.getElementById('newTagName');
            const inputColor = document.getElementById('newTagColor');
            if (!inputName.value) return;
            try {
                const response = await fetch('@Url.Action("CreateTag")', {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
                    body: JSON.stringify({ name: inputName.value, color: inputColor.value })
                });
                if (response.ok) {
                    const tag = await response.json();
                    document.getElementById('noTagsMsg').classList.add('d-none');
                    const list = document.getElementById('tagsList');
                    const wrapper = document.createElement('div');
                    wrapper.className = 'tag-wrapper';
                    wrapper.id = `tag-wrapper-${tag.id}`;

                    wrapper.innerHTML = `
                        <input class="form-check-input d-none tag-checkbox" type="checkbox" name="selectedTagIds" value="${tag.id}" id="tag_${tag.id}" data-color="${tag.color}" checked>
                        <label class="badge rounded-pill fw-normal tag-label badge-tag d-flex align-items-center gap-2" for="tag_${tag.id}">${tag.name}</label>
                        <button type="button" class="btn-delete-tag" onclick="deleteTag(${tag.id})"><i class="bi bi-x"></i></button>
                    `;

                    list.appendChild(wrapper);
                    const newCheckbox = wrapper.querySelector('input');
                    updateTagVisuals(newCheckbox);
                    newCheckbox.addEventListener('change', () => updateTagVisuals(newCheckbox));
                    inputName.value = '';
                }
            } catch (e) { console.error(e); }
        });

        async function deleteTag(id) {
            if (!confirm("Delete this tag?")) return;
            try {
                const response = await fetch('@Url.Action("DeleteTag")', {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
                    body: JSON.stringify({ id: id })
                });
                if (response.ok) {
                    const el = document.getElementById(`tag-wrapper-${id}`);
                    if (el) el.remove();
                    if (document.getElementById('tagsList').children.length === 0)
                        document.getElementById('noTagsMsg').classList.remove('d-none');
                }
            } catch (e) { console.error(e); }
        }
    </script>
}
