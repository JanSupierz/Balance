@page
@model EnableAuthenticatorModel
@{
    ViewData["Title"] = "Configure authenticator app";
    ViewData["ActivePage"] = ManageNavPages.TwoFactorAuthentication;
}

<div class="card card-clean shadow-sm border mb-4">
    <div class="card-body p-4 p-md-5">

        <div class="d-flex align-items-center mb-4">
            <div class="icon-circle md theme-primary me-3 shadow-sm">
                <i class="bi bi-qr-code-scan"></i>
            </div>
            <div>
                <h4 class="fw-bold mb-0" style="color: var(--text-main);">@ViewData["Title"]</h4>
                <p class="text-muted small mb-0">Secure your account with an authenticator app.</p>
            </div>
        </div>

        <partial name="_StatusMessage" for="StatusMessage" />

        <div class="row">
            <div class="col-md-12">
                <p class="text-muted mb-4">Follow these steps to set up your authenticator app:</p>

                <ol class="list-group list-group-numbered list-group-flush mb-4">
                    <li class="list-group-item border-0 px-0 pb-4" style="background-color: var(--bg-surface);">
                        <span class="fw-bold" style="color: var(--text-main);">Download the App</span>
                        <p class="mb-0 text-muted small" style="color: var(--text-muted);">
                            Download a two-factor authenticator app like Microsoft Authenticator or Google Authenticator.
                        </p>
                    </li>

                    <li class="list-group-item border-0 px-0 pb-4" style="background-color: var(--bg-surface);">
                        <span class="fw-bold" style="color: var(--text-main);">Scan QR Code</span>
                        <p class="text-muted small mb-3" style="color: var(--text-muted);">
                            Scan the QR Code below or enter the key manually.
                        </p>

                        <div class="row">
                            <div class="col-md-6 text-center text-md-start mb-3 mb-md-0">
                                <div id="qrCode" class="d-inline-block p-2 border rounded" style="background-color: var(--bg-surface);"></div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 rounded border h-100 d-flex flex-column justify-content-center" style="background-color: var(--bg-surface);">
                                    <small class="text-uppercase text-muted fw-bold mb-1" style="font-size: 0.7rem; color: var(--text-muted);">Manual Entry Key</small>
                                    <code class="fs-5 fw-bold text-main text-break" style="color: var(--text-main);">
                                        @Model.SharedKey
                                    </code>
                                </div>
                            </div>
                        </div>
                    </li>

                    <li class="list-group-item border-0 px-0 pt-2" style="background-color: var(--bg-surface);">
                        <span class="fw-bold" style="color: var(--text-main);">Verify Setup</span>
                        <p class="text-muted small mb-3" style="color: var(--text-muted);">
                            Once scanned, enter the verification code provided by your app below.
                        </p>
                        <form id="send-code" method="post">
                            <div class="form-floating mb-3">
                                <input asp-for="Input.Code" class="form-control input-theme" autocomplete="off" placeholder="Verification Code" />
                                <label asp-for="Input.Code" style="color: var(--text-muted);">Verification Code</label>
                                <span asp-validation-for="Input.Code" class="text-danger small"></span>
                            </div>
                            <button type="submit" class="btn btn-primary btn-pill-action px-5 shadow-sm fw-bold">
                                Verify & Enable
                            </button>
                            <div asp-validation-summary="ModelOnly" class="text-danger small mt-2" role="alert"></div>
                        </form>
                    </li>
                </ol>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script src="~/lib/qrcode.js"></script>

    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            const uri = "@Html.Raw(Model.AuthenticatorUri)";
            if (uri) {
                // Get CSS variable colors dynamically
                const rootStyle = getComputedStyle(document.documentElement);
                const colorDark = rootStyle.getPropertyValue('--text-main').trim() || '#000000';
                const colorLight = rootStyle.getPropertyValue('--bg-surface').trim() || '#ffffff';

                new QRCode(document.getElementById("qrCode"), {
                    text: uri,
                    width: 150,
                    height: 150,
                    colorDark: colorDark,
                    colorLight: colorLight,
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
        });
    </script>
}
